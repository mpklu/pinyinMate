# Feature Specification: Enhanced Interactive Lesson Learning Experience

**Feature Branch**: `003-help-me-refine`  
**Created**: September 30, 2025  
**Status**: Draft  
**Input**: User description: "help me refine lessons feature in this App. Currently the app loads static lessons from public/lessons/ folder and show them in Libary>Lesson page. Clicking \"preview \" does not do anything current. Clicking \"Start\" takes you to annotation page. I want to make the lesson page the most useful page for students to learn chinese. When clicked \"start\", it should load the lesson content and vocabulary if any. provide pinyin and audio playback  to help user study. A button to generate flashcards for all the words in vocabulary. And able to generate a quiz based on the content"

## Execution Flow (main)
```
1. Parse user description from Input
   ‚Üí User wants to enhance lesson learning experience beyond current annotation page
2. Extract key concepts from description
   ‚Üí Actors: Chinese language students, lesson content, vocabulary
   ‚Üí Actions: lesson loading, audio playback, pinyin display, flashcard generation, quiz creation
   ‚Üí Data: lesson content, vocabulary entries, pinyin, audio files
   ‚Üí Constraints: existing JSON lesson structure, current LibraryService architecture
3. For each unclear aspect:
   ‚Üí All requirements are clear from user description
4. Fill User Scenarios & Testing section
   ‚Üí Primary flow: select lesson ‚Üí study content ‚Üí generate study materials
5. Generate Functional Requirements
   ‚Üí Each requirement focused on study experience enhancement
6. Identify Key Entities: Enhanced lesson page, vocabulary study tools, audio controls
7. Run Review Checklist
   ‚Üí No implementation details included, focused on user value
8. Return: SUCCESS (spec ready for planning)
```

---

## ‚ö° Quick Guidelines
- ‚úÖ Focus on WHAT users need and WHY
- ‚ùå Avoid HOW to implement (no tech stack, APIs, code structure)
- üë• Written for business stakeholders, not developers

---

## Clarifications

### Session 2025-09-30
- Q: Where should the flashcard and quiz generation controls be located? ‚Üí A: Floating action buttons always visible while viewing lesson content
- Q: What specific user progress should be tracked during lesson study? ‚Üí A: Only completion status (started/finished) and time spent
- Q: What should be the smallest unit for audio playback segmentation? ‚Üí A: Sentence-level segments with clickable vocabulary words within them
- Q: What types of quiz questions should be generated from lesson content? ‚Üí A: Multiple choice pronunciation questions covering vocabulary, and audio recognition if feasible
- Q: What should be excluded from the lesson preview compared to full study mode? ‚Üí A: Show only basic content display - exclude audio, progress, and study tools

---

## User Scenarios & Testing

### Primary User Story
As a Chinese language student, I want to start a lesson and have access to comprehensive study tools (content display, pinyin, audio, flashcards, quizzes) in one unified learning interface, so that I can efficiently study all aspects of the lesson without navigating between different pages.

### Acceptance Scenarios
1. **Given** I'm on the Library page viewing available lessons loaded via LibraryService, **When** I click "Start" on any lesson card, **Then** I should navigate to `/lesson/:id` route displaying the enhanced lesson page with study tools
2. **Given** I'm on the lesson page and the lesson loads from schema-validated JSON, **When** the lesson content renders, **Then** I should see Chinese text with pinyin annotations generated by pinyin-pro and vocabulary highlighted using existing SegmentHighlight components
3. **Given** I'm viewing lesson content with integrated AudioService, **When** I click on any text segment or vocabulary word, **Then** I should hear audio pronunciation using the Web Speech API integration
4. **Given** I'm on a lesson page with vocabulary from metadata.vocabulary array, **When** I click "Generate Flashcards", **Then** the system should use existing FlashcardService to create SRS-enabled flashcards and navigate to the flashcard study interface
5. **Given** I'm on a lesson page with validated lesson content, **When** I click "Generate Quiz", **Then** the system should use existing QuizService to create questions and navigate to the quiz interface
6. **Given** I'm on the Library page with existing LessonCard components, **When** I click "Preview" on any lesson, **Then** I should see a Material-UI dialog/modal displaying basic lesson content with pinyin annotations but without audio playback, progress tracking, or study tool generation
7. **Given** I have lesson data conforming to the documented schema, **When** the system loads lessons from local or remote sources, **Then** all lessons should be validated using the established validation utilities and display properly
8. **Given** I'm using the enhanced lesson interface, **When** I interact with study features, **Then** my progress should be persisted using the existing SessionContext and localStorage patterns

### Edge Cases & Error Handling Requirements
- **Empty Vocabulary**: System MUST display lesson content normally and disable flashcard generation button when metadata.vocabulary is empty or missing
- **Content Size Limits**: System MUST truncate lesson content at schema-defined character limits and display warning message to user
- **Web Speech API Unavailable**: System MUST detect API availability and gracefully disable audio features with clear user notification while maintaining all other functionality
- **Schema Validation Failures**: System MUST log validation errors, display user-friendly error message, and prevent lesson loading for remote sources with invalid schema
- **Pinyin Generation Failures**: System MUST fallback to displaying original Chinese text without pinyin annotations and log generation errors for debugging
- **Missing Source/Book Metadata**: System MUST accept lessons with missing optional metadata and display appropriate placeholders in lesson information
- **Service Processing Errors**: System MUST implement error boundaries to catch service failures and display recovery options to users
- **localStorage Unavailable**: System MUST detect storage availability and fallback to session-only progress tracking with user notification about non-persistent progress

## Requirements

### Functional Requirements
- **FR-001**: System MUST replace the current annotation page navigation with a dedicated interactive lesson learning page when "Start" is clicked
- **FR-002**: System MUST display lesson content with automatic pinyin annotations using existing pinyin-pro library
- **FR-003**: System MUST provide audio playback capability using existing Web Speech API integration for sentence-level segments with individual vocabulary words clickable within sentences
- **FR-004**: System MUST highlight vocabulary words within lesson content using existing SegmentHighlight and VocabularyTooltip components, making them clickable for individual audio playback
- **FR-005**: System MUST provide a "Generate Flashcards" floating action button that remains visible while viewing lesson content and integrates with existing FlashcardService and SRS system
- **FR-006**: System MUST provide a "Generate Quiz" floating action button that remains visible while viewing lesson content and integrates with existing QuizService to create pronunciation-focused questions (multiple choice for vocabulary pronunciation and audio recognition where feasible)
- **FR-007**: System MUST implement the currently non-functional "Preview" button using existing Modal/Dialog patterns to display basic lesson content with pinyin annotations, excluding audio playback, progress tracking, and study tool generation
- **FR-008**: System MUST segment lesson content into sentence-level units using existing TextSegmentationService for audio playback and study
- **FR-009**: System MUST persist lesson completion status (started/finished) and time spent using existing SessionContext and browser localStorage
- **FR-010**: System MUST provide navigation controls using existing Router patterns and Navigation component
- **FR-011**: System MUST handle lessons conforming to the standardized lesson schema with vocabulary array in metadata
- **FR-012**: System MUST display lesson metadata using existing DifficultyBadge and Material-UI components
- **FR-013**: System MUST validate lesson data using the established lesson schema and validation utilities
- **FR-014**: System MUST support lessons from both local and remote sources following the documented lesson schema

### Technical Constraints
- **TC-001**: MUST use existing TypeScript interfaces from src/types/lesson.ts
- **TC-002**: MUST follow existing Material-UI v5 component patterns and theme system
- **TC-003**: MUST integrate with existing service architecture (LibraryService, LessonService, AudioService)
- **TC-004**: MUST use established lesson schema format with source and book metadata properties
- **TC-005**: MUST leverage existing lazy loading and performance optimization patterns
- **TC-006**: MUST maintain compatibility with existing testing framework (Vitest + React Testing Library)
- **TC-007**: MUST follow established code organization (atoms/molecules/organisms/templates)
- **TC-008**: MUST use existing validation utilities for lesson data integrity

### Key Entities
- **Enhanced Lesson Page Template**: New template component following existing LibraryPage/AnnotationPage patterns
- **Interactive Content Display Organism**: Component using existing ChineseText, PinyinText, and SegmentHighlight atoms
- **Audio Control Integration**: Enhancement to existing AudioService and AudioPlayButton components
- **Study Material Generator Organisms**: Components integrating existing FlashcardService and QuizService
- **Lesson Schema Validator**: Utility using established lesson schema documentation and validation functions
- **Vocabulary Study Tools**: Components using existing VocabularyTooltip and related vocabulary display patterns

## Architecture & Implementation Notes

### Lesson Schema Integration
The feature leverages the enhanced lesson schema that includes:
- **Source Attribution**: `metadata.source` for content attribution and remote library compatibility
- **Book References**: `metadata.book` for textbook integration (nullable for standalone content)
- **Vocabulary Structure**: Vocabulary moved to `metadata.vocabulary` array with simplified `{word, definition}` format
- **Runtime Pinyin**: Pinyin generated using existing pinyin-pro library integration, not stored statically
- **Validation Support**: Schema validation using established utilities in `src/utils/lessonValidation.ts`

### Existing Framework Utilization
- **React 19.1**: Leverage latest React features for component state and effects
- **Material-UI v5**: Use established theme system and component library for consistent UI
- **TypeScript 5.8**: Maintain strict typing with existing interface definitions
- **Vite Build System**: Utilize existing code splitting and lazy loading configurations
- **React Router v7**: Integrate with existing routing patterns for navigation
- **Existing Services**: Build upon LibraryService, LessonService, AudioService, and SRSService

### Code Organization Standards
- **Atomic Design**: Follow established atoms ‚Üí molecules ‚Üí organisms ‚Üí templates hierarchy
- **Service Layer**: Extend existing service patterns for lesson processing and study material generation
- **Type Safety**: Use existing TypeScript interfaces and maintain strict type checking
- **Testing Patterns**: Follow established Vitest + React Testing Library + Playwright patterns
- **Performance Optimization**: Leverage existing lazy loading and code splitting strategies

### Integration Points
- **Library Integration**: Connect with existing LibraryService for lesson loading and caching
- **Audio Integration**: Extend existing AudioService with lesson-specific playback features
- **Navigation Integration**: Use existing Router configuration and Navigation component patterns
- **Study Tools Integration**: Connect with existing FlashcardService and QuizService implementations
- **Theme Integration**: Use established Material-UI theme system for consistent styling

### Schema Documentation Reference
Complete lesson schema documentation is available at:
- **Schema Specification**: `docs/lesson-schema.md` - Comprehensive schema documentation with validation rules
- **JSON Schema**: `schemas/lesson.schema.json` - Machine-readable validation schema
- **Validation Utilities**: `src/utils/lessonValidation.ts` - TypeScript validation functions and migration support
- **Type Definitions**: `src/types/lesson.ts` - TypeScript interfaces matching the schema

All lesson implementations must conform to the documented schema to ensure compatibility with both local and remote library sources.

---

## Review & Acceptance Checklist

### Content Quality
- [x] No implementation details (languages, frameworks, APIs)
- [x] Focused on user value and business needs
- [x] Written for non-technical stakeholders
- [x] All mandatory sections completed

### Requirement Completeness
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Requirements are testable and unambiguous  
- [x] Success criteria are measurable
- [x] Scope is clearly bounded
- [x] Dependencies and assumptions identified (existing services, schema validation, browser Web Speech API support)

---

## Execution Status
*Updated by main() during processing*

- [x] User description parsed
- [x] Key concepts extracted
- [x] Ambiguities marked (resolved via clarification session)
- [x] User scenarios defined
- [x] Requirements generated
- [x] Entities identified
- [x] Review checklist passed

---
